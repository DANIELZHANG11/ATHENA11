# PowerSync Sync Rules for Athena
# Version: 1.0.0
#
# 此文件定义 PowerSync Service 的同步规则。
# 部署时将此文件放置在 PowerSync Service 的配置目录中。
#
# 参考文档:
# - https://docs.powersync.com/usage/sync-rules/
# - https://docs.powersync.com/usage/sync-rules/bucket-definitions

# 全局参数 - 从 JWT Token 中提取
parameters:
  user_id: token_parameters.user_id

# Bucket 定义
# 每个 bucket 定义一组同步到客户端的数据
bucket_definitions:

  # =========================================================================
  # 用户的书籍
  # =========================================================================
  user_books:
    # 仅同步当前用户的数据
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    # 同步书籍基本信息（不包含敏感存储路径）
    data:
      - SELECT
          id,
          title,
          author,
          language,
          original_format,
          size,
          minio_key,
          cover_key,
          ocr_pdf_key,
          sha256,
          processing_status,
          processing_error,
          reader_type,
          is_readable,
          is_interactive,
          has_text_layer,
          is_image_based,
          ocr_status,
          metadata_confirmed,
          meta,
          created_at,
          updated_at,
          -- PowerSync 需要 INTEGER 类型的 is_deleted
          CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END AS is_deleted,
          version
        FROM books
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 阅读位置 (Last Write Wins)
  # =========================================================================
  book_positions:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          book_id,
          chapter_or_page,
          scroll_position_json,
          updated_at
        FROM book_position
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 阅读时长记录
  # =========================================================================
  reading_time_logs:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          book_id,
          started_at,
          ended_at,
          duration_sec,
          synced_at
        FROM reading_time_log
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 笔记 (Conflict Copy 策略)
  # =========================================================================
  user_notes:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          book_id,
          position_json,
          content,
          tags,
          color,
          conflict_of,
          created_at,
          updated_at,
          CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END AS is_deleted
        FROM notes
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 高亮
  # =========================================================================
  user_highlights:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          book_id,
          position_json,
          color,
          text_preview,
          created_at,
          updated_at,
          CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END AS is_deleted
        FROM highlights
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 书签
  # =========================================================================
  user_bookmarks:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          book_id,
          position_json,
          title,
          created_at,
          CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END AS is_deleted
        FROM bookmarks
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 书架 (字段级合并)
  # =========================================================================
  user_shelves:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    # 支持字段级合并
    merge_columns:
      - name
      - color
      - icon
      - sort_order

    data:
      - SELECT
          id,
          name,
          color,
          icon,
          sort_order,
          created_at,
          updated_at,
          CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END AS is_deleted
        FROM shelves
        WHERE user_id = bucket.bucket_id

  # =========================================================================
  # 书架-书籍关联
  # =========================================================================
  shelf_book_relations:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          sb.id,
          sb.shelf_id,
          sb.book_id,
          sb.added_at
        FROM shelf_books sb
        JOIN shelves s ON sb.shelf_id = s.id
        WHERE s.user_id = bucket.bucket_id

  # =========================================================================
  # 用户设置 (字段级合并 via JSONB patch)
  # =========================================================================
  user_settings_bucket:
    parameters:
      - SELECT id AS bucket_id FROM users WHERE id = token_parameters.user_id

    data:
      - SELECT
          id,
          settings_json,
          updated_at
        FROM user_settings
        WHERE user_id = bucket.bucket_id
